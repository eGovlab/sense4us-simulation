'use strict';

function createInput(menuItem) {
    var input = menuItem.addInput();
    var that  = this;

    input.defaultValue(function() {
        if(!input.changeProperty) {
            return '';
        }

        return input.changeObject[input.changeProperty];
    });

    input.onChange(function() {
        var value = input.getValue();
        if(!input.changeCheck(value)) {
            input.setValue(input.changeObject[input.changeProperty]);
            return;
        }

        if(input.setObjectValue) {
           input.changeObject[input.changeProperty] = input.setObjectValue.call(input, value);
        } else {
           input.changeObject[input.changeProperty] = value;
        }

        that.emit('dataModified', input.changeObject, input.changeProperty, value);
        /*loadedModel.floatingWindows.forEach(function(floatingWindow) {
            floatingWindow.refresh();
        });

        loadedModel.emit([value, input.changeProperty, input.changeObject], 'dataModified');
        loadedModel.emit('refresh');*/
    });

    return input;
}

function setupInput(menuItem, row, item) {
    var input = createInput.call(this, menuItem);

    input.changeProperty = row.property;
    input.changeObject   = item;
    input.changeCheck    = row.check;
    
    input.setObjectValue = false;
    if(row.set) {
        input.setObjectValue = row.set;
    }

    input.setLabel(row.property);
    input.refresh();

    if(row.showCondition && !row.showCondition(item)) {
        input.hide();
    } else {
        input.show();
    }

    return input;
}

module.exports = setupInput;