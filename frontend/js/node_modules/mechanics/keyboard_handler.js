'use strict';

module.exports = function(container, canvas, tool, hotkeys) {
    var lookupTable = {};
    var globalTable = {};
    hotkeys.forEach(function(hotkey) {
        if(!lookupTable[hotkey.keyCode]) {
            lookupTable[hotkey.keyCode] = [];
        }

        lookupTable[hotkey.keyCode].push(hotkey);

        if(hotkey.global === true) {
            if(!globalTable[hotkey.keyCode]) {
                globalTable[hotkey.keyCode] = [];
            }

            globalTable[hotkey.keyCode].push(hotkey);
        }
    });

    var SHIFT = 16,
        CTRL  = 17,
        ALT   = 18,
        ALTGR = 225;

    if(!tool.static.modifiers) {
        tool.static.modifiers = [];
    }

    container.addEventListener('keydown', function(evt) {
        /*if(tool.static.modifiers.indexOf(ALT) !== -1) {
            console.log(evt.keyCode);
        }*/

        switch(evt.keyCode) {
            case CTRL:
                tool.static.modifiers.push(CTRL);
                break;
            case ALT:
                tool.static.modifiers.push(ALT);
                break;
            case ALTGR:
                tool.static.modifiers.push(ALTGR);
                break;
            case SHIFT:
                tool.static.modifiers.push(SHIFT);
                break;
        }

        if(window.sense4us.lastTarget !== canvas) {
            if(globalTable[evt.keyCode]) {
                globalTable[evt.keyCode].forEach(function(hotkey) {
                    if(!hotkey.onDown || typeof hotkey.onDown !== 'function') {
                        return;
                    }

                    hotkey.onDown(canvas, tool.static.modifiers, tool.loadedModel, evt);
                });
            }

            return true;
        }

        /**
         * @description A key was pressed with canvas active.
         * @event keyDown
         * @memberof module:model/statusEvents
         *
         * @param {integer} keyCode - Character keycode.
         * @example tool.addListener('keyDown', function(key) {
         *     console.log('Key', key, 'pressed.');
         * });
         */
        tool.emit(evt.keyCode, 'keyDown');

        if(!lookupTable[evt.keyCode]) {
            return true;
        }

        lookupTable[evt.keyCode].forEach(function(hotkey) {
            if(!hotkey.onDown || typeof hotkey.onDown !== 'function') {
                return;
            }

            hotkey.onDown(canvas, tool.static.modifiers, tool.loadedModel, evt);
        });

        //evt.preventDefault();
        //return false;
    });

    container.addEventListener('keyup', function(evt) {
        switch(evt.keyCode) {
            case CTRL:
                var index = tool.static.modifiers.indexOf(CTRL);
                tool.static.modifiers.splice(index, 1);
                break;
            case ALT:
                var index = tool.static.modifiers.indexOf(ALT);
                tool.static.modifiers.splice(index, 1);
                break;
            case ALTGR:
                var index = tool.static.modifiers.indexOf(ALTGR);
                tool.static.modifiers.splice(index, 1);
                break;
            case SHIFT:
                var index = tool.static.modifiers.indexOf(SHIFT);
                tool.static.modifiers.splice(index, 1);
                break;
        }

        if(window.sense4us.lastTarget !== canvas) {
            if(globalTable[evt.keyCode]) {
                globalTable[evt.keyCode].forEach(function(hotkey) {
                    if(!hotkey.onUp || typeof hotkey.onUp !== 'function') {
                        return;
                    }

                    hotkey.onUp(canvas, tool.static.modifiers, tool.loadedModel, evt);
                });
            }

            return true;
        }

        /**
         * @description A key was released with canvas active.
         * @event keyUp
         * @memberof module:model/statusEvents
         *
         * @param {integer} keyCode - Character keycode.
         * @example tool.addListener('keyUp', function(key) {
         *     console.log('Key', key, 'released.');
         * });
         */
        tool.emit(evt.keyCode, 'keyUp');

        if(!lookupTable[evt.keyCode]) {
            return true;
        }

        lookupTable[evt.keyCode].forEach(function(hotkey) {
            if(!hotkey.onUp || typeof hotkey.onUp !== 'function') {
                return;
            }

            hotkey.onUp(canvas, tool.static.modifiers, tool.loadedModel, evt);
        });

        //evt.preventDefault();
        //return false;
    });
};
