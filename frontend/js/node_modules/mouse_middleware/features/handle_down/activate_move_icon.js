'use strict';

var hitTest        = require('collisions').hitTest,
    icon           = require('icon');

var objectHelper   = require('object-helper');

function startMovingIconIfSelected(data, error, done) {
    // if we have a node selected and we aren't linking and we click an icon, then start moving the icon!
    var movingIconNodes = objectHelper.filter.call(
        data.nodeGui,
        function(node) {
            return node.selected === true && node.linking !== true && node.icon !== undefined;
        }
    );

    movingIconNodes = objectHelper.filter.call(
        movingIconNodes,
        function(node) {
            return hitTest(data.pos, icon(node));
        }
    );
    
    movingIconNodes = objectHelper.map.call(
        movingIconNodes,
        function(node) {
            return node.set('movingIcon', true);
        }
    );

    data.nodeGui = objectHelper.merge.call(data.nodeGui, movingIconNodes);

    // if we started to move a node, we use the done-function
    // otherwise it'd go to the next mousehandling-function
    // and try to select something instead
    if (objectHelper.size.call(movingIconNodes) > 0) {
        return done(data);
    }
    
    return data;
}

module.exports = startMovingIconIfSelected;