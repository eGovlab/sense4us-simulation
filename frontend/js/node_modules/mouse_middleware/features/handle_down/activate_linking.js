'use strict';

var linker         = require('linker'),
    hitTest        = require('collisions').hitTest;
    
var objectHelper = require('object-helper');

function startLinkingIfSelected(data, error, done) {
    // if a node is selected and we click the linker-symbol, then start linking!
    var linkingNodes = objectHelper.filter.call(
        data.nodeGui,
        function(node) {
            return node.selected === true;
        }
    );

    linkingNodes = objectHelper.filter.call(
        linkingNodes,
        function(node) {
            return hitTest(data.pos, linker(node));
        }
    );

    linkingNodes = objectHelper.map.call(
        linkingNodes,
        function(node) {
            node.linking = true;
            return node;
        }
    );

    data.nodeGui = objectHelper.merge.call(data.nodeGui, linkingNodes);

    // if we started to link a node, we use the done-function
    // otherwise it'd go to the next mousehandling-function
    // and try to select something instead
    if (objectHelper.size.call(linkingNodes) > 0) {
        return done(data);
    }

    return data;
}

module.exports = startLinkingIfSelected;